#!/bin/bash

proj_dir="/opt/dev/pasedb"
cd $proj_dir

git fetch

if [ "$(git diff --name-only origin/develop | grep auto.deploy)" == "auto.deploy" ]; then
        echo "*** UPDATING PROJECT ***"
#        git pull origin develop
	echo ">>>> merging updates into develop <<<<"
        git pull origin develop
#	git merge

	echo ">>>> compiling new web-ui code <<<<"
#	cd pasedbui
#	mvn clean package	
	cd pasedbui
	mvn clean package

	rm -f docker/paseadb.war
	cp target/pasedb.war docker
	cd docker
	docker rmi pasedbui
	docker build -t pasedbui .


	echo ">>>> docker-compose compile and bring online <<<<"
#	docker-compose build ui
#	docker stop ui
#	docker rm ui
	docker-compose down
	docker-compose up

#	docker-compose up -d --no-deps ui

        echo "*** DEPLOYMENT COMPLETE ***"
        exit 1
else
        echo "project up-to-date, skipping auto.deploy"
        exit 1
fi


